#!/bin/sh

set -e

[ -z "$KAKOUNE_CLIENT" ] && echo "Kakoune client is unset."
[ -z "$KAKOUNE_SESSION" ] && echo "Kakoune session is unset." && \
    exit 1

if ! type jq > /dev/null
then
    "\`jq\` must be installed to use this script."
    exit 1
fi

current_client_query='
    .[]
    | select((.client ==$C) and (.session == $S))'

buffer_name_query="$current_client_query | .buffer_name"
working_directory_query="$current_client_query | .working_directory"

KAKOUNE_CURRENT_BUFFER=$(kcr list | \
   jq \
        --arg C "$KAKOUNE_CLIENT" \
        --arg S "$KAKOUNE_SESSION" \
        --raw-output \
        "$buffer_name_query")

KAKOUNE_CURRENT_WORKING_DIRECTORY="$(kcr list | \
    jq \
        --arg C "$KAKOUNE_CLIENT" \
        --arg S "$KAKOUNE_SESSION" \
        --raw-output \
        "$working_directory_query")"

export KAKOUNE_CURRENT_BUFFER
export KAKOUNE_CURRENT_WORKING_DIRECTORY
