colorscheme terminal

declare-user-mode ultra

hook global BufWritePre ^[^*].* %{
    try %{ execute-keys -draft \%s\h+$<ret>d }
}
hook global FocusOut ^[^.git].* %{
    evaluate-commands %{ write-all }
}
hook global WinCreate ^[^*].* %{
    add-highlighter \
        window/ number-lines -hlcursor -min-digits 3 -separator "  "
}
hook global WinSetOption filetype=(git-commit) %{
    set-option buffer autowrap_column 72
    autowrap-enable
}
hook global WinSetOption filetype=(ruby) %{ lsp-enable-window }

map global normal <space> ":enter-user-mode ultra <ret>" \
    -docstring "Enter Ultra user mode."

map global ultra B  ": buffer *<tab>"
map global ultra b  ": buffer <tab>"
map global ultra d  ": shackle tmux-repl-vertical kd <ret>"
map global ultra f  ": shackle tmux-repl-vertical kf <ret>"
map global ultra q  "| fmt -w %opt{autowrap_column} <ret>"
map global ultra m  ": shackle tmux-repl-vertical kcp <ret>"
map global ultra S  ": shackle tmux-repl-vertical ksüîçüîç <ret>"
map global ultra s  ": shackle tmux-repl-vertical ksüîç <ret>"
map global ultra w  ": shackle tmux-repl-window <ret>"
map global ultra $  ": shackle tmux-repl-window ks <ret>"
map global ultra |  ": shackle tmux-repl-vertical <ret>"
map global ultra \" ": shackle tmux-repl-horizontal <ret>"

set-option -add global ui_options terminal_padding_char=;
set-option -add global ui_options terminal_assistant=none

set-option global autowrap_fmtcmd "fmt -w %opt{autowrap_column}"
set-option global autowrap_format_paragraph true
set-option global idle_timeout 500
set-option global indentwidth 2
set-option global scrolloff 3,6
set-option global tabstop 2

set-option global modelinefmt ''
set-option -add global modelinefmt ' {{mode_info}} '
set-option -add global modelinefmt '‚ï∑ %val{bufname} ‚òû %opt{filetype} ‚ï∑'
set-option -add global modelinefmt ' %val{cursor_char_column}‚à∂?? '

# `kak-lsp`
eval %sh{ kak-lsp --kakoune --session $kak_session }

define-command shackle \
    -params 1.. \
    -command-completion \
    -docstring 'Run a command as <command> sh -c {shackle} -- [arguments].' \
    %{
        %arg{1} sh -c %{
            export KAKOUNE_CLIENT=$1
            export KAKOUNE_CURRENT_BUFFER=$2
            export KAKOUNE_CURRENT_WORKING_DIRECTORY=$3
            export KAKOUNE_SESSION=$4
            shift 5

            [ $# = 0 ] && set "$SHELL"

            "$@"
    } -- %val{client} %val{buffile} %sh{pwd -P} %val{session} %arg{@}
}
